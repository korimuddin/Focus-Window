<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Focus Window ‚Äî Ambient Environments + Pomodoro (robust)</title>
<style>
  :root{ --radius:18px; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:#0b0b0b; color:#e8e8e8; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
  header{display:flex; align-items:center; gap:10px; padding:10px 14px}
  header .spacer{flex:1}
  select,button,input[type="range"],label.chip{background:#151515; color:#e8e8e8; border:1px solid #2a2a2a; padding:10px 12px; border-radius:12px}
  button{cursor:pointer}
  main{display:grid; place-items:center}
  .stage{position:relative; width:90vw; height:90vh; border-radius:var(--radius); overflow:hidden; background:#000; box-shadow:0 30px 80px rgba(0,0,0,.65), 0 0 0 1px #000 inset}
  video{width:100%; height:100%; object-fit:cover; display:block; filter:contrast(1.05) saturate(1.05)}
  .vignette{pointer-events:none; position:absolute; inset:0; background:radial-gradient(ellipse at center, rgba(0,0,0,0) 60%, rgba(0,0,0,.35) 78%, rgba(0,0,0,.7) 100%)}
  #progressRing{position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,.35); border-radius:12px; border:1px solid rgba(255,255,255,.06)}
  /* Ambient bar */
  .ambient{display:flex; gap:8px; align-items:center; padding:8px 14px; flex-wrap:wrap}
  .chip{display:inline-flex; align-items:center; gap:8px}
  .chip input{margin:0}
  .muted{opacity:.75}

  /* Play overlay */
  .overlay{position:absolute; inset:0; display:grid; place-items:center; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
    color:#e5e7eb; font-weight:600; letter-spacing:.3px; opacity:0; pointer-events:none; transition:opacity .2s ease}
  .overlay.show{opacity:1; pointer-events:auto}
  .overlay .btn{display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:1px solid #2a2a2a; background:#151515; cursor:pointer}
  .msg{position:absolute; bottom:10px; left:10px; font-size:.85rem; color:#d1d5db; opacity:.9; padding:6px 10px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.06); border-radius:10px; backdrop-filter:blur(4px)}
</style>
</head>
<body>
<header>
  <label for="scene">Environment:</label>
  <select id="scene" title="Select Environment"></select>
  <div class="spacer"></div>
  <button id="downloadBtn">‚¨áÔ∏è Download .html</button>
</header>
<!-- Ambient controls -->
<div class="ambient" role="group" aria-label="Ambient sound controls">
  <span class="muted">Ambient:</span>
  <label class="chip"><input type="checkbox" class="amb-toggle" value="cabin"> Cabin hum</label>
  <label class="chip"><input type="checkbox" class="amb-toggle" value="rail"> Rail rattle</label>
  <label class="chip"><input type="checkbox" class="amb-toggle" value="rain"> Rain</label>
  <label class="chip"><input type="checkbox" class="amb-toggle" value="library"> Library murmur</label>
  <label class="chip"><input type="checkbox" class="amb-toggle" value="brown"> Brown noise</label>
  <label class="chip" title="Match ambients to selected scene"><input type="checkbox" id="autoAmbient"> Auto ambient with scene</label>
  <span class="muted" style="margin-left:4px">Vol</span>
  <input id="ambVol" type="range" min="0" max="1" step="0.01" value="0.3" aria-label="Ambient volume" />
  <button id="ambStop">‚èπ Stop All</button>
</div>
<main>
  <div class="stage">
    <video id="video" playsinline muted loop preload="auto" autoplay></video>
    <div class="vignette" aria-hidden="true"></div>
    <canvas id="progressRing" width="100" height="100"></canvas>
    <div class="overlay" id="overlay">
      <button class="btn" id="tapToStart">‚ñ∂Ô∏è Click to start video</button>
    </div>
    <div class="msg" id="status">Ready</div>
  </div>
</main>
<script>
// --- Scenes (royalty-free sources; swap anytime) ---
const SCENES = {
  plane:   { label:'‚úàÔ∏è Plane ‚Äî window seat',   src:'https://cdn.coverr.co/videos/coverr-airplane-window-0127/1080p.mp4' },
  train:   { label:'üöÜ Train ‚Äî window seat',    src:'https://cdn.coverr.co/videos/coverr-train-journey-7726/1080p.mp4' },
  library: { label:'üìö Library ‚Äî by the window',src:'https://cdn.coverr.co/videos/coverr-library-sunlight-5709/1080p.mp4' },
  cafe:    { label:'‚òï Rainy caf√© window',       src:'https://assets.mixkit.co/videos/preview/mixkit-raindrops-on-a-window-with-blurred-lights-in-the-background-99839-large.mp4' },
  cabin:   { label:'üèîÔ∏è Mountain cabin window',  src:'https://assets.mixkit.co/videos/preview/mixkit-landscape-outside-a-cabin-in-the-winter-mountains-31637-large.mp4' },
  city:    { label:'üåÉ Nighttime city window',   src:'https://assets.mixkit.co/videos/preview/mixkit-hong-kong-skyline-at-night-47648-large.mp4' }
};

// Cache DOM references up-front
const sceneSel = document.getElementById('scene');
const video = document.getElementById('video');
const ambVol = document.getElementById('ambVol');
const ambStop = document.getElementById('ambStop');
const ambToggles = Array.from(document.querySelectorAll('.amb-toggle'));
const autoAmbient = document.getElementById('autoAmbient');
const downloadBtn = document.getElementById('downloadBtn');
const overlay = document.getElementById('overlay');
const tapToStart = document.getElementById('tapToStart');
const statusMsg = document.getElementById('status');

// --- Ambient sound system ---
let audioCtx = null; // created on first user gesture
const ambGains = {}; const ambNodes = {}; // per-track
const AMBIENTS = {
  cabin:{ label:'Cabin hum', type:'file', src:'https://cdn.pixabay.com/download/audio/2022/03/15/audio_5a5b57cdbd.mp3?filename=airplane-cabin-ambient-19169.mp3' },
  rail:{ label:'Rail rattle', type:'file', src:'https://cdn.pixabay.com/download/audio/2021/09/07/audio_6bcd779b5a.mp3?filename=train-sound-ambient-9192.mp3' },
  rain:{ label:'Rain', type:'file', src:'https://cdn.pixabay.com/download/audio/2021/09/07/audio_7eea5f01ec.mp3?filename=rain-ambience-1-9645.mp3' },
  library:{ label:'Library murmur', type:'file', src:'https://cdn.pixabay.com/download/audio/2022/03/15/audio_8b23d1b3a3.mp3?filename=library-ambience-19167.mp3' },
  brown:{ label:'Brown noise', type:'brown' }
};
const LS = { scene:'fw.scene', ambVol:'fw.amb.vol', ambAct:'fw.amb.act', autoAmb:'fw.autoAmbient' };

function ensureAudio(){ if (!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } if (audioCtx.state==='suspended'){ audioCtx.resume(); } }
function setAmbVolume(v){ Object.values(ambGains).forEach(g=>{ if (g) g.gain.value = v; }); localStorage.setItem(LS.ambVol, String(v)); }
function loadFileNode(key){ if (!AMBIENTS[key] || AMBIENTS[key].type!=='file') return; ensureAudio(); const track = AMBIENTS[key]; const el = new Audio(); el.src = track.src; el.crossOrigin='anonymous'; el.loop=true; el.preload='auto'; const src = audioCtx.createMediaElementSource(el); const gain = audioCtx.createGain(); gain.gain.value = parseFloat(ambVol.value||'0.3'); src.connect(gain).connect(audioCtx.destination); ambNodes[key] = {el, src}; ambGains[key] = gain; el.play().catch(()=>{}); }
function createBrownNoiseNode(key){ ensureAudio(); const bufferSize = 2 * audioCtx.sampleRate; const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const output = noiseBuffer.getChannelData(0); let lastOut = 0.0; for (let i=0;i<bufferSize;i++){ const white=Math.random()*2-1; lastOut=(lastOut+(0.02*white))/1.02; output[i]=lastOut*3.5; } const whiteNoise = audioCtx.createBufferSource(); whiteNoise.buffer=noiseBuffer; whiteNoise.loop=true; const gain = audioCtx.createGain(); gain.gain.value = parseFloat(ambVol.value||'0.3')/2; whiteNoise.connect(gain).connect(audioCtx.destination); ambNodes[key]={node:whiteNoise}; ambGains[key]=gain; whiteNoise.start(); }
function startAmbient(key){ if (ambNodes[key]) return; const def=AMBIENTS[key]; if (!def) return; if (def.type==='file') loadFileNode(key); if (def.type==='brown') createBrownNoiseNode(key); }
function stopAmbient(key){ const n = ambNodes[key]; if (!n) return; if (n.el){ try{ n.el.pause(); n.el.src=''; }catch(e){} } if (n.node){ try{ n.node.stop(); }catch(e){} } if (ambGains[key]) ambGains[key].disconnect(); delete ambNodes[key]; delete ambGains[key]; }
function stopAllAmbients(){ Object.keys(ambNodes).forEach(stopAmbient); ambToggles.forEach(t=>t.checked=false); persistAmbients(); }

function persistAmbients(){ const active = ambToggles.filter(t=>t.checked).map(t=>t.value); localStorage.setItem(LS.ambAct, JSON.stringify(active)); }
(function restoreAmbients(){ const saved = JSON.parse(localStorage.getItem(LS.ambAct)||'[]'); const savedVol = parseFloat(localStorage.getItem(LS.ambVol)); if (!isNaN(savedVol)) ambVol.value = String(savedVol); ambToggles.forEach(t=>{ t.checked = saved.includes(t.value); }); })();
function desiredAmbientsFor(scene){ const map = { plane:['cabin','brown'], train:['rail','rain'], library:['library','rain'], cafe:['rain','brown'], cabin:['brown','rain'], city:['brown'] }; return map[scene]||[]; }
function autoSelectAmbients(scene){ const want = desiredAmbientsFor(scene); ambToggles.forEach(t=>{ t.checked = want.includes(t.value); }); persistAmbients(); }
function applyAutoAmbients(scene){ ensureAudio(); const want = new Set(desiredAmbientsFor(scene)); ambToggles.forEach(t=>{ if (want.has(t.value)){ startAmbient(t.value); t.checked=true; } else { stopAmbient(t.value); t.checked=false; } }); persistAmbients(); }

// Wire ambient UI
ambToggles.forEach(t=>{ t.addEventListener('change', ()=>{ ensureAudio(); if (t.checked){ startAmbient(t.value); } else { stopAmbient(t.value); } persistAmbients(); }); });
ambVol.addEventListener('input', ()=> setAmbVolume(parseFloat(ambVol.value||'0.3')));
ambStop.addEventListener('click', stopAllAmbients);

// Build scene selector options
for (const [key,def] of Object.entries(SCENES)){
  const opt = document.createElement('option');
  opt.value = key; opt.textContent = def.label; opt.dataset.src = def.src; sceneSel.appendChild(opt);
}

// Scene handling (after all refs exist)
function setStatus(msg){ statusMsg.textContent = msg; }
function showOverlay(){ overlay.classList.add('show'); }
function hideOverlay(){ overlay.classList.remove('show'); }

function applyScene(key){
  const def = SCENES[key] || SCENES.plane;
  if (video.src !== def.src){
    video.pause();
    video.removeAttribute('src'); // reset for reliability
    video.load();
    video.src = def.src;
    video.load();
  }
  localStorage.setItem(LS.scene, key);
  setStatus('Loading scene‚Ä¶');
  const playAttempt = video.play();
  if (playAttempt && typeof playAttempt.then === 'function'){
    playAttempt.then(()=>{ hideOverlay(); setStatus('Playing'); }).catch(()=>{ showOverlay(); setStatus('Click ‚ñ∂ to start'); });
  } else {
    // older browsers
    hideOverlay(); setStatus('Playing');
  }
  const aa = document.getElementById('autoAmbient');
  if (aa && aa.checked) applyAutoAmbients(key); else autoSelectAmbients(key);
}
function attemptPlay(){ applyScene(sceneSel.value || 'plane'); }

video.addEventListener('loadeddata', ()=>{ setStatus('Playing'); });
video.addEventListener('error', ()=>{ setStatus('‚ö†Ô∏è Video failed to load'); showOverlay(); });
document.addEventListener('visibilitychange', ()=>{ if (!document.hidden){ attemptPlay(); }});

const saved = localStorage.getItem(LS.scene) || 'plane';
sceneSel.value = SCENES[saved] ? saved : 'plane';
applyScene(sceneSel.value);
sceneSel.addEventListener('change', e=>{ applyScene(e.target.value); });

// Overlay click unlocks playback + audio
['click','keydown','touchstart'].forEach(evt => {
  tapToStart.addEventListener(evt, ()=>{ hideOverlay(); ensureAudio(); attemptPlay(); }, {once:true});
});

// --- Minimal Pomodoro ring (visual only) ---
const POMO = { mode:'focus', remaining:1500 };
function drawProgressRing() {
  const canvas = document.getElementById('progressRing');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const total = (POMO.mode==='focus'?25:(POMO.mode==='short'?5:15))*60;
  const percent = Math.max(0, Math.min(1, POMO.remaining / total));
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // track
  ctx.beginPath();
  ctx.arc(canvas.width/2, canvas.height/2, canvas.width/2 - 6, 0, Math.PI*2);
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 8; ctx.stroke();
  // arc
  ctx.beginPath();
  ctx.arc(canvas.width/2, canvas.height/2, canvas.width/2 - 6, -Math.PI/2, -Math.PI/2 + percent * Math.PI*2);
  ctx.strokeStyle = '#7dd3fc';
  ctx.lineWidth = 8; ctx.lineCap = 'round'; ctx.stroke();
  // label
  ctx.fillStyle = '#e5e7eb'; ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif';
  const m = String(Math.floor(POMO.remaining/60)).padStart(2,'0');
  const s = String(POMO.remaining%60).padStart(2,'0');
  const txt = m+':'+s; const tw = ctx.measureText(txt).width;
  ctx.fillText(txt, canvas.width/2 - tw/2, canvas.height/2 + 5);
}
setInterval(()=>{ if (POMO.remaining>0) POMO.remaining--; drawProgressRing(); }, 1000);
window.addEventListener('load', drawProgressRing);

// Download
downloadBtn.addEventListener('click', ()=>{
  const html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'focus-window-robust.html';
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 500);
});
</script>
</body>
</html>
